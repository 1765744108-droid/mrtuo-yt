import{j as e,R as C,r as i,u as _,V as M,B as R,M as k,F as U,N as W,a as G,A as H,O as B,b as Y,C as $,c as Z,d as X,D as J,e as q,f as V}from"./threejs-X4gI_yP_.js";import{B as K,E as Q,a as ee,R as I,I as te}from"./icons-XI55PPMN.js";import{u as se}from"./gesture-J8PmULBs.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))c(l);new MutationObserver(l=>{for(const n of l)if(n.type==="childList")for(const x of n.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&c(x)}).observe(document,{childList:!0,subtree:!0});function r(l){const n={};return l.integrity&&(n.integrity=l.integrity),l.referrerPolicy&&(n.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?n.credentials="include":l.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(l){if(l.ep)return;l.ep=!0;const n=r(l);fetch(l.href,n)}})();const re=({model:t,onUpdate:s,isActive:r})=>{const c=f=>{const a=Math.PI/2,o=[...t.rotation];f==="x"?o[0]+=a:o[2]+=a,s(t.id,{rotation:[o[0],o[1],o[2]]})},l=()=>{const f=Math.PI/4,a=[...t.rotation];a[1]+=f,s(t.id,{rotation:[a[0],a[1],a[2]]})},n=()=>{s(t.id,{visible:!t.visible})},x=f=>{const o=[...t.position];f==="up"?o[1]+=.025:o[1]=Math.max(0,o[1]-.025),s(t.id,{position:[o[0],o[1],o[2]]})};return e.jsxs("div",{className:`p-2 rounded-lg backdrop-blur-md transition-all duration-300 border ${r?"bg-white/90 border-blue-400 shadow-lg scale-105":"bg-white/70 border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(K,{size:12,className:r?"text-blue-500":"text-gray-500"}),e.jsx("span",{className:`font-semibold text-xs ${r?"text-blue-700":"text-gray-700"}`,children:t.name})]}),e.jsx("button",{onClick:n,className:"p-1 rounded-full hover:bg-gray-100 active:bg-gray-200 transition-colors",title:t.visible?"隐藏":"显示",children:t.visible?e.jsx(Q,{size:14,className:"text-gray-600"}):e.jsx(ee,{size:14,className:"text-gray-400"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-1 mb-1",children:[e.jsxs("button",{onClick:()=>c("x"),className:"flex flex-col items-center justify-center p-1 bg-gray-50 hover:bg-blue-50 border border-gray-200 rounded-md active:scale-95 transition-all",children:[e.jsx(I,{size:12,className:"mb-0.25 text-gray-600"}),e.jsx("span",{className:"text-[9px] text-gray-600",children:"X轴"})]}),e.jsxs("button",{onClick:()=>c("z"),className:"flex flex-col items-center justify-center p-1 bg-gray-50 hover:bg-blue-50 border border-gray-200 rounded-md active:scale-95 transition-all",children:[e.jsx(I,{size:12,className:"mb-0.25 text-gray-600"}),e.jsx("span",{className:"text-[9px] text-gray-600",children:"Z轴"})]}),e.jsxs("button",{onClick:l,className:"flex flex-col items-center justify-center p-1 bg-gray-50 hover:bg-green-50 border border-gray-200 rounded-md active:scale-95 transition-all",children:[e.jsx(I,{size:12,className:"mb-0.25 text-green-600"}),e.jsx("span",{className:"text-[9px] text-green-600",children:"顺时针"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[e.jsxs("button",{onClick:()=>x("up"),className:"flex flex-col items-center justify-center p-1 bg-gray-50 hover:bg-purple-50 border border-gray-200 rounded-md active:scale-95 transition-all",children:[e.jsx("span",{className:"text-sm font-bold text-purple-600",children:"↑"}),e.jsx("span",{className:"text-[9px] text-gray-600",children:"升高"})]}),e.jsxs("button",{onClick:()=>x("down"),className:"flex flex-col items-center justify-center p-1 bg-gray-50 hover:bg-purple-50 border border-gray-200 rounded-md active:scale-95 transition-all",children:[e.jsx("span",{className:"text-sm font-bold text-purple-600",children:"↓"}),e.jsx("span",{className:"text-[9px] text-gray-600",children:"降低"})]})]})]})},ne=({models:t,onUpdate:s,selectedId:r})=>e.jsx("div",{className:"absolute bottom-8 left-4 right-4 flex flex-row gap-3 pointer-events-none",children:t.map(c=>e.jsx("div",{className:"flex-1 pointer-events-auto",children:e.jsx(re,{model:c,onUpdate:s,isActive:r===c.id})},c.id))}),oe="/models/慢热模型 远征队.glb",ae="/models/慢热模型 远征队1.glb",N={background:"#ffffff",ground:"#e5e5e5",grid:"#9ca3af",selection:"#3b82f6"},ie=[13.5,13.5,13.5];class ce{constructor(s=36e5){this.cache=new Map,this.maxAge=s}get(s){const r=this.cache.get(s);return r?Date.now()-r.timestamp>this.maxAge?(this.cache.delete(s),null):r.model:null}set(s,r){this.cache.set(s,{model:r,timestamp:Date.now()})}delete(s){this.cache.delete(s)}clear(){this.cache.clear()}size(){return this.cache.size}}const T=new ce;class le extends C.Component{constructor(s){super(s),this.state={hasError:!1}}static getDerivedStateFromError(s){return{hasError:!0}}componentDidCatch(s,r){console.error("BuildingModel error:",s,r)}render(){return this.state.hasError?this.props.fallback:this.props.children}}const de=({position:t})=>e.jsx("group",{position:t,children:e.jsxs("mesh",{position:[0,1,0],children:[e.jsx("sphereGeometry",{args:[1,16,16]}),e.jsx("meshBasicMaterial",{color:N.selection,opacity:.5,transparent:!0})]})}),ue=({position:t})=>e.jsx("group",{position:t,children:e.jsxs("mesh",{position:[0,1,0],children:[e.jsx("boxGeometry",{args:[2,2,2]}),e.jsx("meshBasicMaterial",{color:"#ef4444",opacity:.5,transparent:!0})]})}),pe=t=>{const s=i.useMemo(()=>T.get(t),[t]),{scene:r,...c}=Y(t);return i.useEffect(()=>{r&&!s&&T.set(t,{scene:r,...c})},[t,r,s]),s||{scene:r,...c}},fe=({data:t,onSelect:s,onUpdate:r,overlapInfo:c})=>{const{scene:l}=pe(t.url),n=i.useRef(null),[x,f]=i.useState(!1),[a,o]=i.useState(t.rotation),[m,v]=i.useState(t.rotation),d=C.useMemo(()=>l.clone(),[l]);i.useEffect(()=>{v(t.rotation)},[t.rotation]),_((p,h)=>{if(a[0]!==m[0]||a[1]!==m[1]||a[2]!==m[2]){const u=5*h,y=a[0]+(m[0]-a[0])*u,w=a[1]+(m[1]-a[1])*u,O=a[2]+(m[2]-a[2])*u;o([y,w,O])}});const[g,b]=i.useState(new M(0,0,0));i.useEffect(()=>{d.position.set(0,0,0),d.updateMatrixWorld(!0);const u=-new R().setFromObject(d).min.y;b(new M(0,u,0)),d.updateMatrixWorld(!0)},[d]),i.useEffect(()=>{d.traverse(p=>{p instanceof k&&(p.castShadow=!0,p.receiveShadow=!0,p.material&&(Array.isArray(p.material)?p.material:[p.material]).forEach(u=>{t.name==="锚定"?(u.transparent=!1,u.opacity=1):t.name==="现实"?(u.transparent=!0,u.opacity=.6):(u.transparent=!1,u.opacity=1),u.depthWrite=!0,u.side=U,u.depthTest=!0,u.blending=W,t.name==="锚定"?u.color.set("#1781b5"):t.name==="现实"?u.color.set("#ee3f4d"):u.color.set(16777215),u.needsUpdate=!0}))})},[d,t.name]);const j=i.useMemo(()=>{if(!c.isOverlapping)return null;const p=l.clone();return p.traverse(h=>{if(h instanceof k&&(h.castShadow=!1,h.receiveShadow=!1,h.material)){const y=(Array.isArray(h.material)?h.material[0]:h.material).clone();y.transparent=!0,y.opacity=.4,y.depthWrite=!1,y.side=G,y.blending=H,t.name==="锚定"?y.color.set("#1781b5"):t.name==="现实"?y.color.set("#ee3f4d"):y.color.set(16777215),h.material=y}}),p},[l,c.isOverlapping,t.name]),S=se({onDragStart:({event:p})=>{p.stopPropagation(),t.selected||s(t.id)},onDrag:({movement:[p,h],touches:u,event:y,memo:w={initialPos:t.position,initialRot:t.rotation}})=>{if(y.stopPropagation(),!t.selected)return w;const O=6,E=-O/2,P=O/2;if(u===1){const A=Math.max(E,Math.min(P,w.initialPos[0]+p*.05)),F=Math.max(E,Math.min(P,w.initialPos[2]+h*.05));r(t.id,{position:[A,w.initialPos[1],F]})}if(u===2){const A=Math.max(E,Math.min(P,w.initialPos[0]+p*.05)),F=w.initialPos[1]+h*.05,z=w.initialPos[2];r(t.id,{position:[A,F,z]})}return w},onClick:({event:p})=>{p.stopPropagation(),s(t.id)}},{drag:{filterTaps:!0,threshold:10}});return t.visible?e.jsxs("group",{ref:n,position:t.position,scale:t.scale,...S(),onPointerOver:()=>f(!0),onPointerOut:()=>f(!1),children:[e.jsx("group",{rotation:a,children:e.jsxs("group",{position:[0,g.y,0],children:[e.jsx("primitive",{object:d}),j&&e.jsx("primitive",{object:j})]})}),t.selected&&e.jsx(B,{thickness:3,color:N.selection,screenspace:!0,opacity:1,transparent:!1,angle:0}),!t.selected&&x&&e.jsx(B,{thickness:2,color:"#9ca3af",screenspace:!0,opacity:.5})]}):null},xe=C.memo(t=>{const{data:s}=t;return e.jsx(i.Suspense,{fallback:e.jsx(de,{position:s.position}),children:e.jsx(le,{fallback:e.jsx(ue,{position:s.position}),children:e.jsx(fe,{...t})})})},(t,s)=>{const r=JSON.stringify(t.data)===JSON.stringify(s.data),c=t.onSelect===s.onSelect&&t.onUpdate===s.onUpdate;return r&&c}),me=({onDeselect:t})=>e.jsxs("mesh",{rotation:[-Math.PI/2,0,0],position:[0,-.01,0],receiveShadow:!0,onPointerMissed:s=>{s.type==="click"&&t()},onClick:s=>{s.stopPropagation(),t()},visible:!1,children:[e.jsx("planeGeometry",{args:[6,6]}),e.jsx("meshStandardMaterial",{color:N.ground,transparent:!0,opacity:0,side:J})]}),he=({models:t})=>{const{camera:s,controls:r}=q(),c=i.useRef(!0);return i.useEffect(()=>{c.current&&t.length>0&&(s.position.set(0,8,10),s.lookAt(0,.5,0),r&&(r.target.set(0,.5,0),r.update()),c.current=!1)},[t,s,r]),null},ge=({models:t,onSelectModel:s,onUpdateModel:r})=>{const[c,l]=i.useState({});return i.useEffect(()=>{if(t.length<2)return;const n={};t.forEach(x=>{n[x.id]={isOverlapping:!1,overlappingWith:[]}});for(let x=0;x<t.length;x++)for(let f=x+1;f<t.length;f++){const a=t[x],o=t[f],m=new R,v=new R,d=new M(...a.position),g=new M(...a.scale),b=new M(1,1,1).multiply(g);m.setFromCenterAndSize(d,b);const j=new M(...o.position),S=new M(...o.scale),p=new M(1,1,1).multiply(S);v.setFromCenterAndSize(j,p),m.intersectsBox(v)&&(n[a.id].isOverlapping=!0,n[a.id].overlappingWith.push(o.id),n[o.id].isOverlapping=!0,n[o.id].overlappingWith.push(a.id))}l(n)},[t]),e.jsxs(e.Fragment,{children:[e.jsx("ambientLight",{intensity:1}),e.jsx("directionalLight",{position:[10,20,10],intensity:1.5,castShadow:!0,"shadow-mapSize":[2048,2048]}),e.jsx("gridHelper",{args:[6,6,N.grid,N.grid],position:[0,.01,0],scale:1,children:e.jsx("lineBasicMaterial",{attach:"material",color:N.grid,transparent:!0,opacity:.7})}),e.jsx(me,{onDeselect:()=>s(null)}),e.jsx(Z,{resolution:1024,scale:50,blur:2,opacity:.5,far:10,color:"#000000"}),t.map(n=>e.jsx(xe,{data:n,onSelect:s,onUpdate:r,overlapInfo:c[n.id]||{isOverlapping:!1,overlappingWith:[]}},n.id)),e.jsx(X,{makeDefault:!0,minPolarAngle:0,maxPolarAngle:Math.PI,enableDamping:!0,dampingFactor:.05,enablePan:!0,enableZoom:!0}),e.jsx(he,{models:t})]})},be=t=>e.jsx($,{shadows:!0,camera:{position:ie,fov:45},style:{background:N.background,touchAction:"none"},dpr:[1,2],children:e.jsx(ge,{...t})}),je=({show:t})=>{const[s,r]=i.useState(60),[c,l]=i.useState(0),[n,x]=i.useState({used:0,total:0}),f=i.useRef([]),a=i.useRef(0),o=i.useRef(0),m=i.useRef({getElapsedTime:()=>Date.now()/1e3});if(i.useEffect(()=>{const d=()=>{const b=m.current.getElapsedTime(),j=b-a.current;if(o.current++,j>=1){const S=o.current/j;r(Math.round(S));const p=j/o.current*1e3;l(p),f.current.push(S),f.current.length>100&&f.current.shift(),o.current=0,a.current=b}requestAnimationFrame(d)},g=requestAnimationFrame(d);return()=>cancelAnimationFrame(g)},[]),i.useEffect(()=>{const g=setInterval(()=>{if(performance&&"memory"in performance){const b=performance.memory;x({used:b.usedJSHeapSize,total:b.totalJSHeapSize})}},1e3);return()=>clearInterval(g)},[]),!t)return null;const v=d=>{if(d===0)return"0 Bytes";const g=1024,b=["Bytes","KB","MB","GB"],j=Math.floor(Math.log(d)/Math.log(g));return parseFloat((d/Math.pow(g,j)).toFixed(2))+" "+b[j]};return e.jsxs("div",{className:"fixed top-4 right-4 bg-black/80 text-white p-3 rounded-lg text-xs font-mono z-50 backdrop-blur-sm pointer-events-auto",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"FPS:"}),e.jsx("span",{className:`${s>50?"text-green-400":s>30?"text-yellow-400":"text-red-400"}`,children:s})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Frame Time:"}),e.jsxs("span",{className:`${c<17?"text-green-400":c<33?"text-yellow-400":"text-red-400"}`,children:[c.toFixed(2),"ms"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Memory Used:"}),e.jsx("span",{children:v(n.used)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Memory Total:"}),e.jsx("span",{children:v(n.total)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Memory Usage:"}),e.jsxs("span",{children:[Math.round(n.used/n.total*100),"%"]})]})]}),e.jsx("div",{className:"mt-2 h-12 w-full relative",children:f.current.map((d,g)=>{const b=d/60*100,j=g/(f.current.length-1)*100;return e.jsx("div",{className:"absolute bottom-0 w-[1px] bg-green-400 opacity-70",style:{height:`${b}%`,left:`${j}%`}},g)})})]})},ye=[{id:"model-1",name:"锚定",url:oe,position:[-1.5,0,0],rotation:[0,0,0],scale:[10,10,10],visible:!0,selected:!1,opacity:1},{id:"model-2",name:"现实",url:ae,position:[1.5,.005,0],rotation:[0,0,0],scale:[10,10,10],visible:!0,selected:!1,opacity:1}],ve=!1,we=!1,Me=!1,Ne=()=>{const[t,s]=i.useState(ye),[r,c]=i.useState(null),[l,n]=i.useState(!1),x=i.useCallback(o=>{c(o),s(m=>m.map(v=>({...v,selected:v.id===o})))},[]),f=i.useCallback((o,m)=>{s(v=>v.map(d=>d.id===o?{...d,...m}:d))},[]),a=()=>r?`已选中：${t.find(m=>m.id===r)?.name} - 单指旋转，双指移动`:"全局视角：单指旋转场景，双指平移视角";return e.jsxs("div",{className:"w-full h-screen relative bg-gradient-to-br from-blue-50 to-white overflow-hidden font-sans text-slate-800",children:[we,e.jsx("div",{className:"absolute inset-0 z-0",children:e.jsx(be,{models:t,onSelectModel:x,onUpdateModel:f})}),e.jsx(je,{show:l}),e.jsxs("div",{className:"absolute inset-0 z-10 pointer-events-none flex flex-col justify-between",children:[e.jsx("div",{className:"pointer-events-auto",children:e.jsx(ne,{models:t,onUpdate:f,selectedId:r})}),e.jsxs("div",{className:"hidden bg-white/90 backdrop-blur shadow-lg border-t border-gray-200 p-4 pb-8 sm:pb-4 pointer-events-auto transition-transform duration-300",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-between gap-4 max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-slate-600 bg-slate-100 px-3 py-1.5 rounded-full",children:[e.jsx(te,{size:16,className:"text-blue-500"}),e.jsx("span",{children:a()})]}),Me,ve]}),e.jsx("div",{className:"text-center mt-3",children:e.jsx("p",{className:"text-[10px] text-gray-400",children:"支持 .glb 格式 • 两个模型可独立控制 • 重叠部分自动透视"})})]})]})]})},D=document.getElementById("root");D&&V.createRoot(D).render(e.jsx(C.StrictMode,{children:e.jsx(Ne,{})}));
